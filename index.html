<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 心理師 - 心語</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        /* 自訂捲軸樣式 */
        .content-area::-webkit-scrollbar {
            width: 8px;
        }
        .content-area::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .content-area::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        .content-area::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
</head>
<body class="bg-slate-100">

    <div id="app" class="flex flex-col h-screen max-w-2xl mx-auto bg-white shadow-xl">

        <!-- 頂部標題欄 -->
        <header class="bg-slate-800 text-white p-4 flex items-center justify-center shadow-md z-10">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 text-teal-300"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M12 18a4 4 0 1 0-4-4"></path><path d="M12 12v6"></path></svg>
            <h1 class="text-xl font-bold">AI 心理師 — 心語</h1>
        </header>

        <!-- 對話內容區域 -->
        <div id="content-area" class="flex-1 p-4 sm:p-6 overflow-y-auto flex flex-col justify-end content-area">
            <div id="chat-container">
                <!-- 訊息會在這裡動態生成 -->
            </div>

            <!-- 初始問題選項 -->
            <div id="initial-questions" class="mt-4">
                <p class="text-sm text-slate-600 mb-3 text-center">或選擇一個常見話題開始：</p>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                    <button class="question-btn">最近壓力好大</button>
                    <button class="question-btn">對未來感到迷惘</button>
                    <button class="question-btn">人際關係好複雜</button>
                    <button class="question-btn">常常感到焦慮</button>
                    <button class="question-btn">覺得自己很孤單</button>
                    <button class="question-btn">如何提升自信？</button>
                </div>
            </div>
        </div>

        <!-- 底部輸入框 -->
        <footer class="p-4 bg-slate-50 border-t border-slate-200">
            <form id="chat-form" class="flex items-center space-x-3">
                <input type="text" id="message-input" placeholder="在這裡輸入您的訊息..."
                    class="flex-1 w-full px-4 py-2 bg-white border border-slate-300 rounded-full focus:outline-none focus:ring-2 focus:ring-teal-500 transition duration-300"
                    autocomplete="off">
                <button type="submit"
                    class="bg-teal-600 text-white rounded-full p-3 hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition duration-300 disabled:bg-slate-400 disabled:cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </button>
            </form>
        </footer>
    </div>

    <!-- 引用 Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-functions-compat.js"></script>

    <script>
        // --- 1. Firebase 設定 (已更新為您自己的設定) ---
        const firebaseConfig = {
          apiKey: "AIzaSyBy4aKghdWxD0JGXuLVhD62zUfQshosnvU",
          authDomain: "yourmind-bde91.firebaseapp.com",
          projectId: "yourmind-bde91",
          storageBucket: "yourmind-bde91.appspot.com",
          messagingSenderId: "1068416630906",
          appId: "1:1068416630906:web:5effc85464bbfac552fbc3",
          measurementId: "G-Y88EVM5KVG"
        };

        // --- 2. 初始化 Firebase ---
        firebase.initializeApp(firebaseConfig);
        const functions = firebase.functions();

        // --- 3. 取得頁面元素 ---
        const contentArea = document.getElementById('content-area');
        const chatContainer = document.getElementById('chat-container');
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const initialQuestionsContainer = document.getElementById('initial-questions');
        const questionButtons = document.querySelectorAll('.question-btn');
        const submitButton = chatForm.querySelector('button[type="submit"]');

        // 用來儲存對話歷史紀錄
        let conversationHistory = [];

        // --- 4. 核心功能函式 ---

        // 自動捲動到最底部
        function scrollToBottom() {
            contentArea.scrollTop = contentArea.scrollHeight;
        }

        // 在畫面上新增一則訊息
        function appendMessage(text, sender) {
            const messageWrapper = document.createElement('div');
            const messageBubble = document.createElement('div');
            messageWrapper.classList.add('flex', 'mb-4', 'w-full');
            messageBubble.classList.add('px-4', 'py-3', 'rounded-xl', 'max-w-md', 'lg:max-w-lg');

            if (sender === 'user') {
                messageWrapper.classList.add('justify-end');
                messageBubble.classList.add('bg-teal-600', 'text-white');
                messageBubble.textContent = text;
            } else if (sender === 'ai') {
                messageWrapper.classList.add('justify-start');
                messageBubble.classList.add('bg-slate-200', 'text-slate-800');
                messageBubble.textContent = text;
            } else if (sender === 'loading') {
                messageWrapper.id = 'loading-indicator';
                messageWrapper.classList.add('justify-start');
                messageBubble.classList.add('bg-slate-200', 'text-slate-500');
                messageBubble.innerHTML = `<div class="flex items-center"><span class="mr-2">正在傾聽...</span><div class="animate-spin rounded-full h-4 w-4 border-b-2 border-slate-500"></div></div>`;
            }

            messageWrapper.appendChild(messageBubble);
            chatContainer.appendChild(messageWrapper);
            scrollToBottom();
            return messageWrapper;
        }

        // 傳送訊息到 Firebase Cloud Function
        async function sendMessageToAI(userMessage) {
            conversationHistory.push({ role: "user", parts: [{ text: userMessage }] });

            const loadingIndicator = appendMessage('', 'loading');
            toggleInput(false);

            try {
                // 呼叫我們在 Firebase 建立的後端函式
                const askGemini = functions.httpsCallable('askGemini');
                const result = await askGemini({ prompt: userMessage, history: conversationHistory });

                const aiResponse = result.data.text;

                // 將 AI 回應加入歷史紀錄並顯示
                conversationHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                loadingIndicator.remove();
                appendMessage(aiResponse, 'ai');

            } catch (error) {
                console.error("呼叫 Firebase Function 時發生錯誤:", error);
                loadingIndicator.remove();
                appendMessage("抱歉，連線似乎有點問題，請稍後再試。", 'ai');
            } finally {
                toggleInput(true);
            }
        }

        // 切換輸入框的啟用/禁用狀態
        function toggleInput(enabled) {
            messageInput.disabled = !enabled;
            submitButton.disabled = !enabled;
            if(enabled) { messageInput.focus(); }
        }

        // --- 5. 設定事件監聽器 ---

        // 監聽表單提交事件
        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const userMessage = messageInput.value.trim();
            if (userMessage) {
                if (!initialQuestionsContainer.classList.contains('hidden')) {
                    initialQuestionsContainer.classList.add('hidden');
                }
                appendMessage(userMessage, 'user');
                sendMessageToAI(userMessage);
                messageInput.value = '';
            }
        });

        // 監聽初始問題按鈕點擊事件
        questionButtons.forEach(button => {
            button.addEventListener('click', () => {
                const questionText = button.textContent;
                initialQuestionsContainer.classList.add('hidden');
                appendMessage(questionText, 'user');
                sendMessageToAI(questionText);
            });
            button.classList.add('w-full', 'p-3', 'bg-white', 'border', 'border-slate-300', 'rounded-lg', 'text-slate-700', 'text-center', 'hover:bg-teal-50', 'hover:border-teal-400', 'transition', 'duration-200', 'cursor-pointer', 'font-medium', 'text-sm');
        });

        // --- 6. 頁面初始載入 ---
        window.addEventListener('load', () => {
            appendMessage("你好，我是你的 AI 心理夥伴「心語」。有什麼想聊聊的嗎？", 'ai');
        });
    </script>
</body>
</html>
